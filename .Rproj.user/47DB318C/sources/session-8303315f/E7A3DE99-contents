# beneat marine 
# 14/10/24 
# PCA of the Teleostei species


setwd("C:/Users/mbeneat/Documents/osmose/parameterizing_ev-osmose-med/tests/repository_for_zenodo")
path_plots <- paste0(getwd(), "/02-Analysis/Outputs/plots")
load(paste0(getwd(), "/02-Analysis/Outputs/IMAGETOT_STD_Log_BodyDepth.RData"))
source(paste0(getwd(), "/02-Analysis/Scripts/00-Functions_for_analysis.R"))



######
# TRAIT TIME RELATED
#####

AXESTOREPRESENT=c(1,2)

# creating the PCA and the data frames associated
PCAteleo <- runPCA(dataplot_noelasmo_2, traits_2)
plot(PCAteleo$x[,1], PCAteleo$x[,2])
plot(PCAteleo)
res.pca <- PCAteleo
# res.pca <- PCA(beta_iv1_tot)
dataacp_noelasmoPLOT <- dataacp_add_colorvector(dataphylo_noelasmo_2, kclusters=7, dataacp_noelasmo_2)
listforplot <- preparedataforplot(numbPCA1=1, numbPCA2=2, dataacp=dataacp_noelasmoPLOT, AA=AAteleo_2, PCA=PCAteleo)
rotation = listforplot[[1]]
matrixAAinPCA = listforplot[[2]]
dataacpPLOT = listforplot[[3]]
dataacpPLOT = dataacpPLOT[, !duplicated(t(dataacpPLOT))]
eigenval = listforplot[[4]]
# dataacpPLOT = dataacpPLOT[, !duplicated(t(dataacpPLOT))] # species data and position in PCA and clusters

# loading the data for the pictures
# periodic_uuid <- get_uuid(name = "mugilidae")
# periodic_pic <- get_phylopic(uuid = periodic_uuid)
# elasmo_uuid <- get_uuid(name = "Squalidae", n=2)
# elasmo_pic <- get_phylopic(uuid = elasmo_uuid[2])
# opp_uuid <- get_uuid(name = "Gobiidae", n=5)
# opp_pic <- get_phylopic(uuid = opp_uuid[3])

# preparing the data for the Archetypes identifications
datatoadd <- matrixAAinPCA[,1:2]
rownames(datatoadd)<- NULL
labels <- c("Periodic", "Equilibrium", "Opportunistic")
datatoadd <- data_frame(x=datatoadd[,1], y=datatoadd[,2], z=labels)

# prepare the data for the arrows indentification
rownames(res.pca$rotation) <- c("Amat", "Amax", "M", "K", "Tlvl", "Hab")


# plot
plot <- fviz_pca_biplot(res.pca,
                label = c("var"),# label = "none", # hide individual labels
                habillage = , # color by groups
                # palette = c("darkblue", "royalblue", "#00AFBB", "lightblue", "#E7B800", "#FC4E07", "darkred"),                
                fill.ind = as.factor(dataphylo_noelasmo$Species),
                col.ind=as.factor(dataphylo_noelasmo$Species),
                select.ind = list(name = dataphylo_noelasmo$Species[which(dataphylo_noelasmo$Species %in% c("Gillichthys_mirabilis", 
                                                                        "Pseudopleuronectes herzensteini",
                                                                        "Lipophrys pholis",
                                                                        "Buglossidium luteum",
                                                                        "Cyclothone braueri",
                                                                        "Chaenocephalus aceratus",
                                                                        "Glossogobius kokius", 
                                                                        "Brevoortia tyrannus"))]), 
                pointshape=19,
                arrowsize = 0.25, 
                col.var = "darkblue", alpha = 0.2, repel= T)+
  scale_colour_manual(values = c("darkorchid4", "#4575b4", "#91bfdb", "#fc8d59", "gold", "red", "forestgreen", "pink"), name="Outliers of the \ncross-validation") +
  # geom_mark_ellipse(aes(fill = as.factor(dataacpPLOT$Class)),
  #                   expand = unit(0.5, "mm"), 
  #                   alpha = 0) +
  # geom_text(data=datatoadd, aes( x=c(x+0.1), y=c(y-0.2), label=z),                 
  #           color="black", 
  #           size=4.5, fontface="bold" )+
  # geom_text(ifelse(dataacpPLOT$Species %in% 
  #                    c("Gadus macrocephalus", "Chaenocephalus aceratus", "Lipophrys pholis",
  #                      "Engraulis australis", "Brevortia tyrannus"), 
  #                  "Outlier", "Not outlier"))
  # geom_point(data=datatoadd, aes( x=x, y=y),                 , 
  #            color=c("tomato", "royalblue"), #"royalblue"), 
  #            size = 6,
  #            stroke = 1, fill = "white")+
  ggtitle(NULL)+
  labs()+ #fill = "Cluster", color = "Contrib", alpha = "contrib") +
  theme_minimal()+
  theme(text = element_text(size = 12),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 12))+
  guides(shape="none", fill="none")
# add_phylopic(periodic_pic, alpha = 1, x = as.numeric(datatoadd[2,1]+1), y = as.numeric(datatoadd[2,2])+1, ysize = 0.4)+
# add_phylopic(elasmo_pic, alpha = 1, x = as.numeric(datatoadd[1,1])+1, y = as.numeric(datatoadd[1,2])-1, ysize = 0.4)+
# add_phylopic(opp_pic, alpha = 1, x = as.numeric(datatoadd[3,1])-1.5, y = as.numeric(datatoadd[3,2]), ysize = 0.4)

plot
pdf(file = paste0(path_plots, "/outliers_teleo.pdf"), height = 8, width=6.8)
plot
dev.off()




selected_species <- c("Gillichthys_mirabilis", 
                      "Pseudopleuronectes herzensteini",
                      "Lipophrys pholis",
                      "Buglossidium luteum",
                      "Cyclothone braueri",
                      "Chaenocephalus aceratus",
                      "Glossogobius kokius", 
                      "Brevoortia tyrannus")

fviz_pca_biplot(res.pca,
                label = "var",
                # habillage = dataphylo_noelasmo$Species,
                fill.ind = as.factor(dataphylo_noelasmo$Species),
                col.ind = as.factor(dataphylo_noelasmo$Species),  # Coloration des points sélectionnés
                # pointshape = ifelse(dataphylo_noelasmo$Species %in% selected_species, 17, 19),  # Formes différentes pour les points sélectionnés
                arrowsize = 0.25,
                col.var = "darkblue",
                alpha = 0.5) +
  scale_colour_manual(values = c("red", "gray"), name = "Selected Points") +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12))
